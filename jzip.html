<html>
<head>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="jzip.js"></script>
<style>
#inputline {
  position: relative;
}
#inputline>.prompt {
  position: absolute;
  top: 0; left: 0;
}
#inputline>input {
  border: none;
  width: 100%;
  padding: 0 0 0 1.5em;
  margin: 0;
  background-color: #f8f8f8;
}
#inputline>input:focus {
  background-color: #eee;
  border: none;
  outline: none;
}
div.output {
  margin-bottom: 0.2em;
  min-height: 0.5em;
}
div.echo {
  margin-bottom: 0.2em;
  min-height: 0.5em;
  color: gray;
}
div.output, #inputline, #inputline>input, #statuswindow {
  font-family: serif;
  font-size: 12pt;
}
div.output.reverse {
  color: white;
  background-color: black;
}
div.output.bold {
  font-weight: bold;
}
div.output.emph {
  font-style: italic;
}
div.output.fixed {
  font-family: monospace;
}
#statuswindow {
  display: none;
  width: 100%;
  background-color: black;
  color: white;
  font-weight: bold;
  position: fixed;
  top: 0; left: 0;
  min-height: 1em;
  padding: 0.5em 0 0.5em 0;
}
#statuswindow>span.builtin {
  float: right;
  padding-right: 1em;
  display: none;
}

#statuswindow>span.row {
  position: absolute;
  padding-left: 1em;
  left:0;
}

.dialog {
  position: fixed;
  top: 1em;
  border: 1px solid black;
  box-shadow: 3px 3px 15px rgba(0,0,0,0.3);
  padding: 0.5em;
  background-color: white;
}
.dialog>h1 {
  font-size:15pt;
  margin: 0;
}
.dialog>div>h2 {
  font-size:13pt;
  margin: 0.5em 0 0 0;
}
.option {
  position: relative;
  margin-left: 2em;
  min-height: 2em;
  clear: both;
}
.option>br {
  clear: both
}
.option input[type=radio] {
  position: relative;
  left: -2em;
}
.option>button {
  float: right;
}
.cloudsave { display: none }
.cloudrestore { display: none }

.localsave { /*display: none */ }
</style>
</head>
<body>

<div id="statuswindow">
<span class="builtin" id="time">Time:</span>
<span class="builtin" id="moves">Moves:</span>
<span class="builtin" id="score">Score:</span>
</div>

<div id="inputline">
  <input id="input" type="text">
  <span class="prompt"><b>&gt;</b></span>
</div>

<div class="dialog" id="savedialog">
  <h1>Save game&hellip;</h1>
  <div class="localsave">
    <h2>&hellip;in this browser</h2>
    <div class="option">
      <input type="radio" name="savetype" value="localnew" checked/>
      <input type="text" id="savelocalnewname" placeholder="New File"/>
      <br/>
      <div class="haslocal">
      <input type="radio" name="savetype" value="localold"/>
      <select id="savelocaloldname">
      <option>awesome_save.sav</option>
      </select>
      </div>
      <br/>
      <button>Save</button>
      <br/>
    </div>
  </div>
  <div class="filesave">
    <h2>&hellip;on this computer</h2>
    <div class="option">
      <a download="save.sav" id="downloadsave" href="">Download save file&hellip;</a>
    </div>
  </div>
  <div class="cloudsave">
    <h2>&hellip;in the cloud</h2>
    <div class="option">
      <input type="radio" name="savetype"/>
      <button>Save</button>
    </div>
  </div>
</div>

<div class="dialog" id="restoredialog">
  <h1>Restore game&hellip;</h1>
  <div class="localrestore haslocal">
    <h2>&hellip;from this browser</h2>
    <div class="option">
      <input type="radio" name="restoretype" value="localold"/>
      <select id="restorelocaloldname">
      <option>awesome_save.sav</option>
      </select>
      <br/>
      <button>Restore</button>
      <br/>
    </div>
  </div>
  <div class="filerestore">
    <h2>&hellip;from this computer</h2>
    <div class="option">
      <input type="file" id="uploadfile"/>
    </div>
  </div>
  <div class="cloudrestore">
    <h2>&hellip;in the cloud</h2>
    <div class="option">
      <input type="radio" name="restoretype"/>
      <button>Restore</button>
    </div>
  </div>
</div>

<script>
(function(){
  var $input = $('#input')
    , $save = $('#savedialog')
    , $dload = $('#downloadsave')
    , $restore = $('#restoredialog')
    , $statw = $('#statuswindow')
    , srows = [], s_row=1, s_col=1
    , ls = window.localStorage || null
    , lsave = {}                        // copy of localStorage sagegames
    , saveString = ''                   // current savegame stringified
    , history = ( ls && JSON.parse(ls.getItem('jszipHistory')||'[]') ) || []
    , hindex = history.length
    , hmax = 100                        // size of command history
    , restoreOpts = null
    , keyCallback = null
    , lineCallback = null;

  // hook key events up to input widget
  $input.focus().keydown(function(e) { 
    var v = $input.val();
    //console.log(e.keyCode);
    switch(e.keyCode) {
      case 38: // Cursor up
        if (hindex>0) {
          if(v!=='') { history[hindex] = v; }
          $input.val(history[--hindex]);
        }
        e.preventDefault();
        break;
      case 40: // Cursor down
        if(hindex<history.length) {
          if (v!=='') { history[hindex] = v; }
          $input.val(history[++hindex]);
        }
        e.preventDefault();
        break;
      case 13: // Enter 
        if (v!=='') {
          hindex = history.length;
          history[hindex++] = v; 
          // only keep the last hmax commands in the history
          if(hindex>hmax) {
            history=history.slice(-hmax);
            hindex=hmax;
          }
          ls.setItem('jszipHistory',JSON.stringify(history))
        }
        if(lineCallback) {
          $input.val('');
          lineCallback(v);
        } else {
          e.preventDefault();
        }
        break;
    }
    e.stopPropagation();
  });

  // hook key events up to document
  $(document).keydown(function(e) {
    console.log(e.keyCode);
    if( keyCallback ) {
      keyCallback(e.keyCode);
    } else {
      switch(e.keyCode) {
        case 27: // ESC
          // if dialog open
          $('.dialog').fadeOut();
          step();
          break;
      }
    }
  });

  // hide input widgets
  $('#inputline').hide();
  $('#readkey').hide();

  // get saves from localStorage
  if(ls) {
    lsave = JSON.parse(ls.getItem('jszipSaves')||'{}');
  } else {
    $('.localsave').hide();
  }

  // build save/restore widgets
  $save.hide();
  $restore.hide();
  $dload.click(function(){
    $save.fadeOut();
    step();
  });
  // auto select radio buttons
  $('#savelocaloldname').focus(function(){$('#savedialog input[type=radio]').val(['localold']);});
  $('#savelocalnewname').focus(function(){$('#savedialog input[type=radio]').val(['localnew']);});
  $('#restorelocaloldname').focus(function(){$('input[type=radio]',$restore).val(['localold']);});
  $('#restorelocalnewname').focus(function(){$('input[type=radio]',$restore).val(['localnew']);});
  // save buttons
  $('.localsave button',$save).click(saveLocal);
  $('.localrestore button',$restore).click(restoreLocal);
  // file upload
  $('#uploadfile').change(function(e){restoreFile(e.target.files)});


  // functions to be called from the c code
  var out = window['output']={ buf:'', text: true, reverse: false, bold: false, emph: false, fixed: false }
    , argstore = window['argstore']={};
  var writeChar = window['jsWriteChar'] = function(c) {
    console.log('jsWriteChar',c,String.fromCharCode(c));
    if(c==13 || c==10 ) {
      if(out.text) {
        var $line = $('<div class="output"></div>').text(out.buf).insertBefore($('#inputline'));
        if( out.reverse ) $line.addClass('reverse');
        if( out.bold ) $line.addClass('bold');
        if( out.emph ) $line.addClass('emph');
        if( out.fixed ) $line.addClass('fixed');
        scrollBottom();
      } else {
        srows[s_row-1].text(out.buf);
      }
      out.buf='';
    } else {
      out.buf += String.fromCharCode(c);
    }
  }
  window['jsPrintString'] = function(s) {
    var c,t='',p=s,l=[]; 
    while(c=Module.getValue(p++, 'i8')) {
      writeChar(c);
      t+=String.fromCharCode(c);
      l.push(c)
    } 
    if(l.length>0) console.log('printstring',p-s,s,p,t,l);
  }
  window['jsFlushTo'] = function(s) {
    var c=$('#'+s);
    if(out.buf=='') {
      c.hide();
    } else {
      c.text(out.buf).show();
      out.buf='';
    }
  }
  window['jsBlankStatus'] = function() {
    console.log('blank_status()');
  }
  window['jsMoveCursor'] = function(row,col) {
    console.log(out.text,row,col,out.buf);
    if( !out.text ) {
      s_row=row;
      s_col=col;
    }
  }
  window['jsSplitWindow'] = function(lines) {
    $('body').css('padding-top',(lines+1)+'em');
    if(lines) {
      $statw.show().css('height',lines+'em');
      $('.row',$statw).remove();
      srows=[];
      for(var i=0; i<lines; ++i ) {
        srows[i] = $('<span class="row"></span>').css('top',i+'.5em').attr('id','row'+(i+1)).appendTo($statw);
      }
    } else {
      $statw.hide();
    } 
  }
  window['jsSetAttribute'] = function( normal,reverse, bold, emph, fixed ) {
    out.reverse = ~~reverse;
    out.bold    = ~~bold;
    out.emph    = ~~emph;
    out.fixed   = ~~fixed;
    console.log('jsSetAttribute',out);
  }


  // tasks
  function taskGetLine(e) {
    var t=e.timeout,h=null;
    
    // display input line
    $('#inputline').show();
    $input.focus();
    scrollBottom();
    lineCallback=function(text) { 
      var i,l=text.length;
      
      // clean up
      $('#inputline').hide();
      $input.blur();
      lineCallback=null;
      if(h) clearTimeout(h);
      
      // echo input
      $('#inputline').before($('<div class="echo"></div>').text('> '+text));

      // put text into buffer
      for(i=0;i<l;++i) {
        Module.setValue(e.buffer+i,text.charCodeAt(i),'i8');
      }
      jsrGetLine(e.cbuf, e.buffer, l, 13, e.timeout, e.action_routine );
      step();
    };

    // set up a timeout
    if(t>0) {
      h = setTimeout(function(){ 
        $('#inputline').hide();
        $input.blur();
        lineCallback=null;
        jsrGetLine(e.cbuf, e.buffer, 0, -1, e.timeout, e.action_routine ); 
        step(); 
      },t*1000);
    }
  }
  function taskInputCharacter(e) {
    var t=e.timeout,h=null;

    // display readkey bar

    keyCallback = function(c) {
      //clean up
      keyCallback = null;
      /* hide readkey bar */
      if(h) clearTimeout(h);

      jsrInputCharacter(c,t);
      step();
    }
    // set up a timeout
    if(t>0) {
      h = setTimeout(function(){ 
        keyCallback = null;
        jsrInputCharacter(-1,t); 
        step(); 
      },t*1000);
    }
  }
  function taskSave() {
    fillFileSelect('#savelocaloldname');
    $save.fadeIn();
    // base64 encode the save.sav tmp for download
    $dload.attr('href','data:text/csv;base64,'+base64enc(FS.readFile('save.sav')));
    // sringify for localStorage
    saveString = stringify(FS.readFile('save.sav'));
    FS.unlink('save.sav');
  }
  function taskRestore(e) {
    fillFileSelect('#restorelocaloldname');
    $restore.fadeIn();
    restoreOpts=e;
    // provide the save.sav tmp file
  }

  
  // exported functions
  var spinupJS  = Module.cwrap('spinupJS', 'number', ['string'])
    , interpret = Module.cwrap('interpret', 'number')
    , jsrGetLine = Module.cwrap('jsrGetLine', 'number', ['number','number','number','number','number','number'])
    , jsrInputCharacter = Module.cwrap('jsrInputCharacter', 'number', ['number','number'])
    , zRestore = Module.cwrap('z_restore', 'number', ['number','number','number','number']);

  // helper functions 
  function scrollBottom() {
    $('body')[0].scrollTop=$('body').height()
  }
  function base64enc(file) {
    // http://www.webtoolkit.info/javascript-base64.html
    var output = "",
        keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
        chr1, chr2, chr3, enc1, enc2, enc3, enc4,
        i = 0;

    while (i < file.length) {
      chr1 = file[i++]; chr2 = file[i++]; chr3 = file[i++];

      enc1 = chr1 >> 2;
      enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
      enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
      enc4 = chr3 & 63;

      if (isNaN(chr2)) {
        enc3 = enc4 = 64;
      } else if (isNaN(chr3)) {
        enc4 = 64;
      }
      output += keyStr.charAt(enc1) + keyStr.charAt(enc2) + keyStr.charAt(enc3) + keyStr.charAt(enc4);
    }
    return output;
  }
  function stringify(l) {
    var i, t='';
    for(i=0; i<l.length; ++i ) {
      t+=String.fromCharCode(l[i]+65);
    }
    return t;
  }
  function unstringify(t) {
    var i, l=[];
    for(i=0; i<t.length; ++i ) {
      l.push(t.charCodeAt(i)-65);
    }
    return l;
  }
  function fillFileSelect(s) {
    var g,$s=$(s),n=true;
    $s.empty();
    for(g in lsave) {
      if( lsave.hasOwnProperty(g) ) {
        $s.append($('<option></option>').text(g).attr('value',g));
        n=false;
      }
    }
    if(n) { $('.haslocal').hide() }
    else  { $('.haslocal').show() }
  }
  function saveLocal() {
    var name, mode = $('#savedialog input[type=radio]:checked').val();
    if( mode=='localnew' ) {
      name = $('#savelocalnewname').val();
    } else if(mode=='localold') {
      name = $('#savelocaloldname').val();
    } else {
      throw Error('Unknown save mode!');
    }
    // empty name
    if( name=='' ) return;
    // save to localstorage
    lsave[name] = saveString;
    ls.setItem('jszipSaves',JSON.stringify(lsave));
    // get back into game
    $save.fadeOut();
    step();
  }
  function restoreLocal() {
    var e=restoreOpts, name, mode = $('input[type=radio]:checked',$restore).val();
    if(mode=='localold') {
      name = $('#restorelocaloldname').val();
    } else {
      throw Error('Unknown save mode!');
    }

    if(e==null) {
      throw Error('No z_restore options available!');
    }
    FS.createDataFile('/', 'save.sav', unstringify(lsave[name]), true, true);
    restoreOpts=null;
    $restore.fadeOut();
    zRestore(e.count,e.o0,e.o1,e.o2);
    step();
  }
  function restoreFile(fl) {
    if(fl.length!=1) return;
    var f=fl[0];

    // instantiate a new FileReader
    var reader = new FileReader();
    reader.onload=function(e) {
      FS.unlink('save.sav');
      FS.createDataFile('/', 'save.sav', e.target.result, true, true);
      restoreOpts=null;
      $restore.fadeOut();
      zRestore(e.count,e.o0,e.o1,e.o2);
      step();
    }
    reader.readAsBinaryString(f);
  }

  // Start z-machine
  spinupJS('zork2.z3');
  //spinupJS('curses.z5');

  // call interpreter
  function step() {
    try {
      interpret();
    } catch(e) {
      console.log('Exception:',e);
      switch(e.task||'') {
        case 'getLine': 
          taskGetLine(e); 
          break;
        case 'inputCharacter': 
          taskInputCharacter(e); 
          break;
        case 'z_save':
          taskSave();
          break
        case 'z_restore':
          taskRestore(e);
          break
        default:
          throw e;
      }
    }
  }
  step();
})();
</script>
</body>
</html>
