<html>
<head>
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="jzip.js"></script>
<style>
#inputline {
  position: relative;
}
#inputline>.prompt {
  position: absolute;
  top: 0; left: 0;
}
#inputline>input {
  border: none;
  width: 100%;
  padding: 0 0 0 1.5em;
  margin: 0;
  background-color: #f8f8f8;
}
#inputline>input:focus {
  background-color: #eee;
  border: none;
  outline: none;
}
div.output {
  margin-bottom: 0.2em;
  min-height: 0.5em;
}
div.output, #inputline, #inputline>input, #statuswindow {
  font-family: serif;
  font-size: 12pt;
}
#statuswindow {
  display: none;
  width: 100%;
  padding: 0.5em;
  background-color: black;
  color: white;
  font-weight: bold;
  position: fixed;
  top: 0; left: 0;
}

</style>
</head>
<body>
<div id="statuswindow"></div>
<div id="inputline">
<input id="input" type="text">
<span class="prompt"><b>&gt;</b></span>
</span>
<script>
(function(){
  var history = ['south','examine house','open door','west','lift rug']
    , hindex = history.length
    , $input = $('#input')
    , $statw = $('#statuswindow')
    , lineCallback = null;

  // hook key events up to input widget
  $input.focus().keydown(function(e) { 
    var v = $input.val();
    //console.log(e.keyCode);
    switch(e.keyCode) {
      case 38: // Cursor up
        if (hindex>0) {
          if(v!=='') { history[hindex] = v; }
          $input.val(history[--hindex]);
        }
        e.preventDefault();
        break;
      case 40: // Cursor down
        if(hindex<history.length) {
          if (v!=='') { history[hindex] = v; }
          $input.val(history[++hindex]);
        }
        e.preventDefault();
        break;
      case 13: // Enter 
        if (v!=='') {
          hindex = history.length;
          history[hindex++] = v; 
        }
        if(lineCallback) {
          $input.val('');
          lineCallback(v);
        } else {
          e.preventDefault();
        }
        break;
    }
  });

  // hide input widget
  $('#inputline').hide();

  // functions to be called from the c code
  var out = window['output']={ buf:'', text: true }
    , argstore = window['argstore']={};
  var writeChar = window['jsWriteChar'] = function(c) {
    if(c==13 || c==10 ) {
      if(out.text) {
        $('#inputline').before($('<div class="output"></div>').text(out.buf));
      } else {
        $statw.text(out.buf);
      }
      out.buf='';
    } else {
      out.buf += String.fromCharCode(c);
    }
  }
  window['jsPrintString'] = function(s) {
    var c,t='',p=s; 
    while(c=Module.getValue(p++, 'i8')) {
      writeChar(c);
    } 
    console.log('printstring',p-s,s,p);
  }
  window['jsBlankStatus'] = function() {
    console.log('blank_status()');
  }
  window['jsMoveCursor'] = function(row,col) {
    console.log(out.text,row,col);
  }
  window['jsSplitWindow'] = function(lines) {
    $('body').css('padding-top',(lines+1)+'em');
    if(lines) {
      $statw.show().css('height',lines+'em');
    } else {
      $statw.hide();
    } 
  }

  // tasks
  function taskGetLine(e) {
    var t=e.timeout,h=null;
    
    // display input line
    $('#inputline').show();
    $input.focus();
    lineCallback=function(text) { 
      var i,l=text.length;
      
      // clean up
      $('#inputline').hide();
      lineCallback=null;
      if(h) clearTimeout(h);

      // put text into buffer
      for(i=0;i<l;++i) {
        Module.setValue(e.buffer+i,text.charCodeAt(i),'i8');
      }
      jsrGetLine(e.cbuf, e.buffer, l, 13, e.timeout, e.action_routine );
    };

    // set up a timeout
    if(t>0) {
      h = setTimeout(function(){ jsrGetLine(e.cbuf, e.buffer, 0, -1, e.timeout, e.action_routine ) },t*1000);
    }
  }
  
  // exported functions
  var spinupJS  = Module.cwrap('spinupJS', 'number', ['string'])
    , interpret = Module.cwrap('interpret', 'number')
    , jsrGetLine = Module.cwrap('jsrGetLine', 'number', ['number','number','number','number','number','number']);


  // Start z-machine
  spinupJS('zork2.z3');

  // call interpreter
  try {
    interpret();
  } catch(e) {
    console.log('Exception:',e);
    switch(e.task||'') {
      case 'getLine': 
        taskGetLine(e); 
        break;
      default:
        throw e;
    }
  }
})();
</script>
</body>
</html>
